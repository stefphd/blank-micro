# Introduction

This repository contains a blank source code for systems controlled by a micro-controller unit (Teensy 4.1-based 🚀️).

## Pre-requisites

* *arduino-builder* (>=1.6.1), also provided with Arduino IDE
* *MATLAB/Simulink* with the *Embedded Coder Toolbox* installed (>=2021a), for control algorithm code generation only

No other dependecies are necessary: all used libraries are already included in `./lib/`.

Additional utilities (only recommended):

* *teensyduino*: not stricktly necessary for compilation b/c core code for teensy MCU is already included in `./tools/`
* *Visual Studio Code* with *C/C++* extension for code completation
* *make* to build using the `Makefile`
* *Doxygen* to generate the documentation
* *KiCad* to open the schematic files

See the installation guide for the pre-requisites for details.

## Documentation

Documentation for the source code and the user-defined libraries (but not for other third-party libraries) can be generated from the source using *Doxygen* with

```bash
doxygen
```

or using *make*

```bash
make doc
```

Generated documentation includes only a html version in `./docs/html`, with main file `index.html`. Documentation is also available on <https://stefphd.github.io/SBBMicro/>.
A latex documentation may be also generated by setting

```doxygen
GENERATE_LATEX  = YES
```

in `Doxyfile`. The latex version will be in `./docs/latex`, and can be compiled using latex with

```bash
cd ./docs/latex
make
```

which generates the pdf file `./doc/latex/refman.pdf`.

\attention Latex documentation requires having both *latex* and *make* installed.

## Code generation

Code generation of the control algorithm is performed via *MATLAB/Simulink* with the *Embedded Coder Toolbox*. Other toolboxes may be required. Code generation can be launch with *MATLAB* using

```MATLAB
startup;
gencode()
```

The general usage of this function is

```MATLAB
startup;
gencode(modelname,dest_dir);
```

where `modelname` is the name of the Simulink model (without the `*.slx` extension included), while `dest_dir` is the destination directory: generated code is placed in `./dest_dir/modelname/src`. If no modelname is given, the function uses the first `*.slx` file found in the current directory. If no destination directory is given, the functions uses `./lib`. Code generation may be also performed using *make*, however this may take some time.

\note Toolboxes required by the code generation can be shown by running in MATLAB

```MATLAB
startup;
check_toolbox();
```

\attention For a correct usage in this project the above functions should be run in the main directory, and not in `./matlab-tools/`.

## Building

Compilation is performed using the *arduino-builder*. Bash scripts provide simple usage depending on the operative system:

* Linux:
  
  ```bash
  ./build_linux.sh
  ```
  
  or
  
  ```bash
  bash build_linux.sh
  ```
  
  \note Tested with Arch-Linux x64.

* Windows:
  
  ```bash
  ./build_win.bat
  ```
  
  \note Tested with Windows 10 x64.

* MacOS: not implemented yet, however it should be similar to Linux.

Alternatively, one can use `ctrl+shift+B` to build the code in *Visual Studio Code* with both Linux and Windows (this makes use of `build_linux.sh` or `build_win.sh` depending on the operative system). One may also use *make* the building and uploading.

\note The above shell scripts perform both the building and the uploading: it is not possible to build or upload only.

## Make tools

One may also use *make* for the building, uploading and the documentation generation. This allows several operations using similar syntax, so as to perform single operations at a time:

* `make` or `make all` to build and upload the code.
* `make build` to build the code only
* `make upload` to upload code only
* `make clean` to clean the build and cache directories
* `make remake` to clean, build and upload the code
* `make rebuild` to clean and rebuild
* `make doc` to build the documentation
* `make cleandoc` to clean the documentation
* `make help` to print the Makefile help

\note The above commands can be also used at the same time, e.g. `make build doc` to build and generate the documentation.
